# Phase 4: æœ€å¼ºå½¢æ€ (GraphRAG & Fine-tuning) - å¼€å‘è®¡åˆ’

## ğŸ“‹ ç›®æ ‡
æ‹¥æœ‰ä¸Šå¸è§†è§’ï¼Œç†è§£æ•°æ®ä¹‹é—´çš„éšæ€§å…³è”ï¼Œå¹¶åœ¨å‚ç›´é¢†åŸŸè¾¾åˆ°ä¸“å®¶çº§æ°´å¹³ã€‚

**æ ¸å¿ƒç†å¿µï¼š** ç»“æ„åŒ–çŸ¥è¯† + é¢†åŸŸé€‚é…

---

## ğŸ—ï¸ æ–°å¢æŠ€æœ¯

| ç»„ä»¶ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| **çŸ¥è¯†å›¾è°±** | GraphRAG | ä»æ–‡æœ¬è‡ªåŠ¨æŠ½å–å®ä½“å’Œå…³ç³»æ„å»ºçŸ¥è¯†å›¾è°± |
| **å®ä½“æŠ½å–** | LLM-based NER | ä½¿ç”¨ LLM è¿›è¡Œå‘½åå®ä½“è¯†åˆ« |
| **å…³ç³»æŠ½å–** | LLM-based RE | ä½¿ç”¨ LLM è¿›è¡Œå…³ç³»æŠ½å– |
| **å›¾å­˜å‚¨** | Neo4j / å†…å­˜å›¾ | æ”¯æŒå¤šç§å›¾å­˜å‚¨åç«¯ |
| **å›¾æ£€ç´¢** | Graph Traversal | åŸºäºå›¾éå†çš„æ£€ç´¢ç­–ç•¥ |
| **Embedding å¾®è°ƒ** | Sentence Transformers | ä½¿ç”¨ç§æœ‰æ•°æ®å¾®è°ƒ Embedding æ¨¡å‹ |
| **LLM å¾®è°ƒæ•°æ®** | QA Pair Generator | è‡ªåŠ¨ç”Ÿæˆå¾®è°ƒè®­ç»ƒæ•°æ® |

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/stage_4/
â”œâ”€â”€ __init__.py                    # åŒ…åˆå§‹åŒ–
â”œâ”€â”€ config.py                      # Stage 4 æ‰©å±•é…ç½®
â”‚
â”œâ”€â”€ graph_rag/                     # GraphRAG æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py                # æ¨¡å—åˆå§‹åŒ–
â”‚   â”œâ”€â”€ entity_extractor.py        # å®ä½“æŠ½å–å™¨
â”‚   â”œâ”€â”€ relation_extractor.py      # å…³ç³»æŠ½å–å™¨
â”‚   â”œâ”€â”€ knowledge_graph.py         # çŸ¥è¯†å›¾è°±æ ¸å¿ƒç±»
â”‚   â”œâ”€â”€ graph_store.py             # å›¾å­˜å‚¨ï¼ˆæ”¯æŒ Neo4j / å†…å­˜ï¼‰
â”‚   â”œâ”€â”€ graph_retriever.py         # å›¾æ£€ç´¢å™¨
â”‚   â””â”€â”€ graph_rag_chain.py         # GraphRAG é“¾
â”‚
â”œâ”€â”€ fine_tuning/                   # å¾®è°ƒæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py                # æ¨¡å—åˆå§‹åŒ–
â”‚   â”œâ”€â”€ embedding_finetuner.py     # Embedding å¾®è°ƒå™¨
â”‚   â”œâ”€â”€ llm_finetuner.py           # LLM å¾®è°ƒæ•°æ®å‡†å¤‡
â”‚   â””â”€â”€ training_data_generator.py # è®­ç»ƒæ•°æ®ç”Ÿæˆå™¨
â”‚
â”œâ”€â”€ ultimate_rag_chain.py          # ç»ˆæ RAG é“¾
â”œâ”€â”€ main.py                        # ä¸»å…¥å£
â””â”€â”€ tests/
    â”œâ”€â”€ __init__.py                # æµ‹è¯•åŒ…åˆå§‹åŒ–
    â””â”€â”€ test_graph_rag.py          # å•å…ƒæµ‹è¯•
```

---

## ğŸ”§ å®ç°æ­¥éª¤

### Step 1: é…ç½®æ¨¡å— (config.py)
- ç»§æ‰¿ Stage 3 é…ç½®
- æ·»åŠ  GraphRAG ç›¸å…³å‚æ•°
- æ·»åŠ å¾®è°ƒç›¸å…³å‚æ•°
- Neo4j è¿æ¥é…ç½®

### Step 2: å®ä½“æŠ½å–å™¨ (entity_extractor.py)
- ä½¿ç”¨ LLM è¿›è¡Œå®ä½“è¯†åˆ«
- æ”¯æŒå¤šç§å®ä½“ç±»å‹ï¼š
  - äººç‰© (Person)
  - ç»„ç»‡ (Organization)
  - åœ°ç‚¹ (Location)
  - äº‹ä»¶ (Event)
  - æ¦‚å¿µ (Concept)
  - äº§å“ (Product)
  - æ—¶é—´ (Time)
- å®ä½“æ¶ˆæ­§å’Œæ ‡å‡†åŒ–
- æ‰¹é‡å¤„ç†ä¼˜åŒ–

### Step 3: å…³ç³»æŠ½å–å™¨ (relation_extractor.py)
- ä»æ–‡æœ¬ä¸­æå–å®ä½“é—´å…³ç³»
- å…³ç³»ç±»å‹å®šä¹‰ï¼š
  - éš¶å±å…³ç³» (belongs_to)
  - åˆä½œå…³ç³» (cooperates_with)
  - ç«äº‰å…³ç³» (competes_with)
  - æŠ•èµ„å…³ç³» (invests_in)
  - ç®¡ç†å…³ç³» (manages)
  - ä½äº (located_in)
  - å‚ä¸ (participates_in)
  - ç”Ÿäº§ (produces)
- å…³ç³»ç½®ä¿¡åº¦è¯„åˆ†
- å…³ç³»æ–¹å‘ç¡®å®š

### Step 4: çŸ¥è¯†å›¾è°±æ ¸å¿ƒ (knowledge_graph.py)
- å›¾æ•°æ®ç»“æ„å®šä¹‰
- èŠ‚ç‚¹ï¼ˆå®ä½“ï¼‰ç®¡ç†
- è¾¹ï¼ˆå…³ç³»ï¼‰ç®¡ç†
- å›¾åˆå¹¶ç­–ç•¥
- å­å›¾æå–

### Step 5: å›¾å­˜å‚¨ (graph_store.py)
- æŠ½è±¡å­˜å‚¨æ¥å£
- å†…å­˜å›¾å­˜å‚¨å®ç°
- Neo4j å­˜å‚¨å®ç°ï¼ˆå¯é€‰ï¼‰
- å›¾æŒä¹…åŒ–å’ŒåŠ è½½
- å¢é‡æ›´æ–°æ”¯æŒ

### Step 6: å›¾æ£€ç´¢å™¨ (graph_retriever.py)
- åŸºäºå…³é”®è¯çš„å®ä½“åŒ¹é…
- å›¾éå†æ£€ç´¢ç­–ç•¥ï¼š
  - ä¸€è·³é‚»å±…
  - å¤šè·³è·¯å¾„
  - æœ€çŸ­è·¯å¾„
- å­å›¾æŠ½å–
- ç¤¾åŒºæ£€æµ‹
- æ£€ç´¢ç»“æœèåˆ

### Step 7: GraphRAG é“¾ (graph_rag_chain.py)
- æ•´åˆå®ä½“æŠ½å–ã€å›¾æ„å»ºã€å›¾æ£€ç´¢
- æŸ¥è¯¢ç†è§£å’Œå®ä½“è¯†åˆ«
- åŸºäºå›¾ç»“æ„çš„ä¸Šä¸‹æ–‡å¢å¼º
- å…¨å±€æ‘˜è¦ç”Ÿæˆ

### Step 8: Embedding å¾®è°ƒå™¨ (embedding_finetuner.py)
- è®­ç»ƒæ•°æ®æ ¼å¼å®šä¹‰
- å¯¹æ¯”å­¦ä¹ æ•°æ®æ„å»º
- Sentence Transformers å¾®è°ƒæµç¨‹
- æ¨¡å‹è¯„ä¼°å’Œä¿å­˜

### Step 9: LLM å¾®è°ƒæ•°æ®å‡†å¤‡ (llm_finetuner.py)
- QA å¯¹è‡ªåŠ¨ç”Ÿæˆ
- æŒ‡ä»¤å¾®è°ƒæ•°æ®æ ¼å¼
- æ•°æ®è´¨é‡è¯„ä¼°
- å¯¼å‡ºä¸ºæ ‡å‡†æ ¼å¼ï¼ˆJSONLï¼‰

### Step 10: è®­ç»ƒæ•°æ®ç”Ÿæˆå™¨ (training_data_generator.py)
- ä»æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆé—®ç­”å¯¹
- éš¾åº¦åˆ†çº§
- æ•°æ®å¢å¼º

### Step 11: ç»ˆæ RAG é“¾ (ultimate_rag_chain.py)
- æ•´åˆ Stage 1-4 æ‰€æœ‰ç»„ä»¶
- æ™ºèƒ½æ£€ç´¢ç­–ç•¥é€‰æ‹©ï¼š
  - ç®€å•é—®é¢˜ â†’ å‘é‡æ£€ç´¢
  - å…³ç³»é—®é¢˜ â†’ å›¾æ£€ç´¢
  - å¤æ‚é—®é¢˜ â†’ æ··åˆæ£€ç´¢
- ç­”æ¡ˆç»¼åˆå’ŒéªŒè¯

### Step 12: æµ‹è¯•ä¸ä¼˜åŒ–
- å•å…ƒæµ‹è¯•
- é›†æˆæµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•
- ä¸å‰åºé˜¶æ®µæ•ˆæœå¯¹æ¯”

---

## ğŸ¯ æŠ€æœ¯é€‰å‹

| åŠŸèƒ½ | æŠ€æœ¯æ–¹æ¡ˆ | è¯´æ˜ |
|------|---------|------|
| å®ä½“/å…³ç³»æŠ½å– | LLM + Structured Output | åˆ©ç”¨ LLM å¼ºå¤§çš„è¯­è¨€ç†è§£èƒ½åŠ› |
| å›¾å­˜å‚¨ | NetworkX + Neo4j | å¼€å‘ç”¨å†…å­˜å›¾ï¼Œç”Ÿäº§ç”¨ Neo4j |
| ç¤¾åŒºæ£€æµ‹ | Leiden Algorithm | ç”¨äºå…¨å±€æ‘˜è¦ç”Ÿæˆ |
| Embedding å¾®è°ƒ | Sentence Transformers | æˆç†Ÿçš„å¾®è°ƒæ¡†æ¶ |
| è®­ç»ƒæ•°æ®æ ¼å¼ | JSONL | é€šç”¨çš„å¾®è°ƒæ•°æ®æ ¼å¼ |

---

## ğŸ“Š GraphRAG å·¥ä½œæµç¨‹

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           åŸå§‹æ–‡æ¡£                   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         æ–‡æ¡£åˆ†å—å¤„ç†                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                       â”‚                       â”‚
          â–¼                       â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å®ä½“æŠ½å–   â”‚          â”‚ å…³ç³»æŠ½å–   â”‚          â”‚ å‘é‡åŒ–    â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚                       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         çŸ¥è¯†å›¾è°±æ„å»º                 â”‚
                    â”‚   (èŠ‚ç‚¹: å®ä½“, è¾¹: å…³ç³»)             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         ç¤¾åŒºæ£€æµ‹ & æ‘˜è¦              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   æŒä¹…åŒ–å­˜å‚¨   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” æ£€ç´¢æµç¨‹

```
ç”¨æˆ·æŸ¥è¯¢
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŸ¥è¯¢åˆ†æ    â”‚ â”€â”€â”€ è¯†åˆ«æŸ¥è¯¢ä¸­çš„å®ä½“å’Œæ„å›¾
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                  â”‚                  â”‚
    â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å‘é‡æ£€ç´¢â”‚      â”‚  å›¾è°±æ£€ç´¢   â”‚      â”‚ç¤¾åŒºæ‘˜è¦  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚                  â”‚                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  ç»“æœèåˆ    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  ç­”æ¡ˆç”Ÿæˆ    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… é¢„æœŸæˆæœ

- èƒ½å¤Ÿå›ç­”è·¨æ–‡æ¡£çš„ã€å…¨å±€æ€§çš„æ¦‚æ‹¬é—®é¢˜
- ç†è§£å®ä½“é—´çš„éšæ€§å…³è”
- æ”¯æŒè·¯å¾„æŸ¥è¯¢ï¼ˆå¦‚"Aå…¬å¸å’ŒBå…¬å¸ä¹‹é—´çš„å…³ç³»é“¾"ï¼‰
- æä¾›å¾®è°ƒèƒ½åŠ›ï¼Œé€‚é…å‚ç›´é¢†åŸŸ
- RAG ç³»ç»Ÿè¾¾åˆ°å¤©èŠ±æ¿çº§åˆ«æ€§èƒ½

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### GraphRAG åŸºæœ¬ä½¿ç”¨

```python
from src.stage_4.graph_rag import GraphRAGChain
from src.stage_4.config import get_stage4_config

# åˆå§‹åŒ–
config = get_stage4_config()
graph_rag = GraphRAGChain(documents, config=config)

# æ„å»ºçŸ¥è¯†å›¾è°±
graph_rag.build_knowledge_graph()

# æŸ¥è¯¢
result = graph_rag.ask("Aå…¬å¸å’ŒBå…¬å¸ä¹‹é—´æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ")
print(result.answer)
print(result.related_entities)
print(result.traversal_path)
```

### Embedding å¾®è°ƒ

```python
from src.stage_4.fine_tuning import EmbeddingFineTuner

# å‡†å¤‡è®­ç»ƒæ•°æ®
fine_tuner = EmbeddingFineTuner(
    base_model="BAAI/bge-base-zh-v1.5",
    output_dir="./models/finetuned_embedding"
)

# ä»æ–‡æ¡£ç”Ÿæˆè®­ç»ƒæ•°æ®
training_data = fine_tuner.generate_training_data(documents)

# å¼€å§‹å¾®è°ƒ
fine_tuner.train(training_data, epochs=3)

# ä¿å­˜æ¨¡å‹
fine_tuner.save()
```

### LLM å¾®è°ƒæ•°æ®å‡†å¤‡

```python
from src.stage_4.fine_tuning import LLMFineTuner

# ç”Ÿæˆå¾®è°ƒæ•°æ®
llm_finetuner = LLMFineTuner(config)
qa_pairs = llm_finetuner.generate_qa_pairs(documents)

# å¯¼å‡ºä¸º JSONL æ ¼å¼
llm_finetuner.export_jsonl(qa_pairs, "training_data.jsonl")
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Neo4j æ˜¯å¯é€‰çš„**ï¼šé»˜è®¤ä½¿ç”¨å†…å­˜å›¾å­˜å‚¨ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½® Neo4j
2. **LLM è°ƒç”¨æˆæœ¬**ï¼šå®ä½“/å…³ç³»æŠ½å–ä¼šå¢åŠ  LLM è°ƒç”¨æ¬¡æ•°ï¼Œæ³¨æ„æˆæœ¬æ§åˆ¶
3. **å¾®è°ƒéœ€è¦ GPU**ï¼šEmbedding å¾®è°ƒå»ºè®®ä½¿ç”¨ GPU åŠ é€Ÿ
4. **æ•°æ®éšç§**ï¼šå¾®è°ƒæ•°æ®å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œæ³¨æ„æ•°æ®å®‰å…¨

